<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NefroQuest: Reino Sombrio do N√©fron</title>
  <style>
    :root{--bg:#05070f;--panel:#0b1222;--panel2:#111b31;--line:#2a3d65;--text:#e5edff;--muted:#93a4cb;--gold:#f0c674;--ok:#34d399;--bad:#f87171}
    *{box-sizing:border-box} body{margin:0;color:var(--text);font-family:Inter,system-ui;background:radial-gradient(circle at 10% 0,#1d2a49 0,transparent 35%),radial-gradient(circle at 90% 0,#2c1747 0,transparent 30%),var(--bg);min-height:100vh;padding:16px}
    .layout{max-width:1380px;margin:0 auto;display:grid;grid-template-columns:390px 1fr;gap:14px}
    .panel{background:linear-gradient(180deg,var(--panel2),var(--panel));border:1px solid var(--line);border-radius:18px;box-shadow:0 20px 50px #0008;overflow:hidden}
    .left{padding:14px}.right{padding:18px}
    h1{margin:0;font-size:1.5rem;background:linear-gradient(90deg,#c7d2fe,#f0c674);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{margin:6px 0 12px;color:var(--muted);font-size:.9rem}
    .hero-card,.hud,.equip,.journal,.qbox,.feedback,.refs,.controls{background:#0f1830c9;border:1px solid var(--line);border-radius:12px}
    .hero-card{padding:10px;margin-bottom:10px}.hero-top{display:flex;gap:10px;align-items:center}
    .hero-portrait{width:74px;height:74px;border-radius:12px;border:1px solid #49628f;object-fit:cover;background:#0b1222}
    .hero-class{font-weight:700}.xp{margin-top:8px;height:10px;background:#0b1020;border:1px solid #2a3d65;border-radius:999px;overflow:hidden}.xp>div{height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#a78bfa);transition:width .2s}
    .hud{padding:10px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px}.tile{border:1px solid #2d436f;border-radius:10px;padding:8px;background:#0b1329;text-align:center}.tile span{display:block;color:var(--muted);font-size:.72rem}
    .equip{padding:10px;margin-bottom:10px}.equip-grid{display:grid;grid-template-columns:1fr;gap:6px}.slot{font-size:.82rem;padding:7px;border-radius:9px;border:1px solid #2d436f;background:#0b1329}.slot-head{display:flex;gap:8px;align-items:center}.slot img{width:24px;height:24px;border-radius:6px}
    .rar-common{color:#cbd5e1}.rar-rare{color:#93c5fd}.rar-epic{color:#c4b5fd}.rar-legendary{color:#fbbf24;font-weight:700}
    .journal{padding:10px;min-height:130px;font-size:.84rem}.journal p{margin:0 0 6px}
    .qbox{padding:14px;margin-bottom:10px;min-height:110px}#question{margin:0;line-height:1.5;font-size:1.05rem}
    .options{display:grid;gap:8px}.option{border:1px solid #314973;background:#0b1329;color:var(--text);border-radius:10px;padding:11px;text-align:left;cursor:pointer}.option:hover:not(:disabled){border-color:#6ea7ff}.option.correct{border-color:var(--ok);background:#123126}.option.wrong{border-color:var(--bad);background:#39191f}
    .feedback{padding:11px;min-height:76px;margin-top:10px}.feedback.good{border-color:#1f7c5f}.feedback.bad{border-color:#8f3a45}
    .refs{padding:10px;margin-top:8px;font-size:.88rem}.refs ul{margin:6px 0 0;padding-left:18px}.refs a{color:#93c5fd;text-decoration:none}.refs a:hover{text-decoration:underline}
    .controls{padding:10px;margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid #486b9f;background:linear-gradient(180deg,#6ea7ff,#3f67ad);color:white;border-radius:9px;padding:9px 12px;font-weight:700;cursor:pointer}.btn.secondary{background:#243753}.hidden{display:none}
    .modal-wrap.hidden{display:none}.modal-wrap{position:fixed;inset:0;background:#0008;display:grid;place-items:center;z-index:30}.modal{width:min(680px,92vw);background:linear-gradient(180deg,#0f1830,#0a1226);border:1px solid var(--line);border-radius:14px;padding:14px}
    table{width:100%;border-collapse:collapse;margin-top:8px}th,td{border-bottom:1px solid #2b426c;padding:7px;text-align:left;font-size:.87rem}
    @media(max-width:1020px){.layout{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <main class="layout">
    <section class="panel left">
      <h1>NefroQuest: Reino Sombrio do N√©fron</h1>
      <p class="subtitle">300 cartas desafiadoras para prova de t√≠tulo em nefrologia.</p>
      <div class="hero-card">
        <div class="hero-top">
          <img class="hero-portrait" src="assets/hero-nephromancer.svg" alt="Her√≥i" />
          <div><div id="heroClass" class="hero-class">Novi√ßo da Filtra√ß√£o</div><small id="heroFlavor">"A noite √© longa, mas o n√©fron resiste."</small></div>
        </div>
        <div class="xp"><div id="xpFill"></div></div><small id="xpLabel">XP 0 / 120</small>
      </div>
      <div class="hud">
        <div class="tile"><span>N√≠vel</span><strong id="level">1</strong></div><div class="tile"><span>Pontos</span><strong id="score">0</strong></div><div class="tile"><span>Vidas</span><strong id="lives">‚ù§‚ù§‚ù§</strong></div>
        <div class="tile"><span>Recorde</span><strong id="record">0</strong></div><div class="tile"><span>Ouro</span><strong id="gold">0</strong></div><div class="tile"><span>Streak</span><strong id="streak">0</strong></div>
      </div>
      <div class="equip"><strong>Arsenal Arcano</strong><div id="equipList" class="equip-grid"></div></div>
      <div class="journal"><strong>Cr√¥nicas</strong><div id="journalLog"></div></div>
    </section>

    <section class="panel right">
      <div class="qbox"><p id="question"></p></div>
      <div id="options" class="options"></div>
      <div id="feedback" class="feedback">Escolha a melhor alternativa cl√≠nica.</div>
      <div id="refs" class="refs"></div>
      <div class="controls">
        <button id="nextBtn" class="btn hidden">Pr√≥xima carta</button>
        <button id="newGameBtn" class="btn secondary">Novo jogo</button>
        <button id="leaderboardBtn" class="btn secondary">Leaderboard</button>
      </div>
    </section>
  </main>

  <div id="leaderboardModal" class="modal-wrap hidden"><div class="modal"><h3 style="margin:0">Leaderboard</h3><table><thead><tr><th>#</th><th>Pontos</th><th>N√≠vel</th><th>Data</th></tr></thead><tbody id="leaderboardBody"></tbody></table><div style="margin-top:10px"><button id="closeLeaderboardBtn" class="btn">Fechar</button></div></div></div>

  <script>
    const refsDB={kdigo_ckd:{label:"KDIGO CKD 2024",url:"https://kdigo.org/guidelines/ckd-evaluation-and-management/"},kdigo_aki:{label:"KDIGO AKI",url:"https://kdigo.org/guidelines/acute-kidney-injury/"},kdigo_gn:{label:"KDIGO Glomerular Diseases",url:"https://kdigo.org/guidelines/glomerular-diseases/"},kdigo_mbd:{label:"KDIGO CKD-MBD",url:"https://kdigo.org/guidelines/ckd-mineral-and-bone-disorder/"},kdigo_tx:{label:"KDIGO Transplant",url:"https://kdigo.org/guidelines/transplant-recipient-care/"},dapa:{label:"DAPA-CKD (NEJM)",url:"https://www.nejm.org/doi/full/10.1056/NEJMoa2024816"},empa:{label:"EMPA-KIDNEY (NEJM)",url:"https://www.nejm.org/doi/full/10.1056/NEJMoa2204233"},figaro:{label:"FIGARO-DKD",url:"https://www.nejm.org/doi/full/10.1056/NEJMoa2110956"},fidelio:{label:"FIDELIO-DKD",url:"https://www.nejm.org/doi/full/10.1056/NEJMoa2025845"},hypona:{label:"Guideline Hyponatremia",url:"https://academic.oup.com/ndt/article/29/suppl_2/i1/1843686"},ispd:{label:"ISPD Peritoneal Dialysis",url:"https://ispd.org/guidelines/"},kdoi:{label:"KDOQI",url:"https://www.kidney.org/professionals/guidelines"}};
    const scenarioWrappers=["Qual √© a conduta mais alinhada √†s diretrizes para","Em discuss√£o avan√ßada de enfermaria, qual alternativa melhor interpreta","Na avalia√ß√£o de alta complexidade, qual decis√£o evita erro cl√°ssico em","Diante de caso lim√≠trofe em ambulat√≥rio de DRC, qual conduta est√° correta para","No contexto de estratifica√ß√£o de risco, qual op√ß√£o melhor representa","Em um caso com m√∫ltiplas comorbidades, qual atitude √© mais adequada em","Sob perspectiva de medicina baseada em evid√™ncias, qual op√ß√£o √© prefer√≠vel para","Em quest√£o com pegadinha conceitual, qual alternativa √© a melhor sobre","Na integra√ß√£o nefro-cardio-metab√≥lica, qual estrat√©gia √© mais apropriada para","Em paciente complexo com risco de progress√£o, qual resposta √© tecnicamente superior para"];
    const topicBlueprints=[
      {t:"confirma√ß√£o de DRC com eGFR lim√≠trofe e sedimento inocente",c:"solicitar cistatina C e usar equa√ß√£o combinada creatinina+cistatina quando apropriado",d:["usar apenas ureia para estadiar","priorizar clearance de creatinina 24h como padr√£o ouro ambulatorial","indicar bi√≥psia renal sem crit√©rios adicionais"],e:"A combina√ß√£o creatinina+cistatina pode refinar a estimativa de TFG em cen√°rios lim√≠trofes; clearance de 24h frequentemente superestima e √© pouco reprodut√≠vel.",r:["kdigo_ckd"]},
      {t:"uso contempor√¢neo da f√≥rmula de Cockcroft-Gault",c:"reconhecer desuso geral, mas considerar para ajuste de dose de algumas medica√ß√µes espec√≠ficas",d:["substituir CKD-EPI em toda avalia√ß√£o renal","usar para estadiar albumin√∫ria","descartar completamente em qualquer contexto farmacol√≥gico"],e:"Cockcroft-Gault perdeu protagonismo para estadiamento, mas ainda pode ser √∫til para dose de alguns f√°rmacos.",r:["kdigo_ckd"]},
      {t:"interpreta√ß√£o cl√≠nica da cistatina C",c:"integrar com creatinina e contexto, lembrando influ√™ncia de inflama√ß√£o e tireoide",d:["usar exclusivamente em urina de 24h","considerar totalmente independente de fatores extra-renais","substituir toda avalia√ß√£o cl√≠nica"],e:"Cistatina C melhora acur√°cia em conjunto, por√©m n√£o √© imune a vari√°veis cl√≠nicas extra-renais.",r:["kdigo_ckd"]},
      {t:"primeira linha farmacol√≥gica na DRC diab√©tica com albumin√∫ria",c:"manter bloqueio do SRAA (IECA/BRA) se tolerado",d:["preferir AINE cr√¥nico","suspender anti-hipertensivos para preservar perfus√£o","iniciar corticosteroide como rotina"],e:"IECA/BRA permanece pilar em DRC protein√∫rica diab√©tica, salvo contraindica√ß√µes.",r:["kdigo_ckd"]},
      {t:"monitoriza√ß√£o de efeitos adversos dos iSGLT2",c:"vigiar infec√ß√µes genitais e cetoacidose euglic√™mica em contexto cl√≠nico apropriado",d:["priorizar risco de hipercalcemia severa como evento principal","considerar aus√™ncia de eventos adversos relevantes","interromper sempre ao primeiro dip de creatinina"],e:"iSGLT2 t√™m benef√≠cio cardiorrenal robusto e perfil de seguran√ßa conhecido com vigil√¢ncia direcionada.",r:["dapa","empa","kdigo_ckd"]},
      {t:"indica√ß√£o de finerenona em DRC diab√©tica",c:"considerar em DM2 com albumin√∫ria persistente apesar de IECA/BRA e pot√°ssio monitor√°vel",d:["indicar em qualquer albumin√∫ria sem diabetes","evitar em todos usu√°rios de SRAA","usar sem controle de pot√°ssio"],e:"Evid√™ncia principal (FIDELIO/FIGARO) envolve DM2 com albumin√∫ria residual em terapia padr√£o.",r:["fidelio","figaro"]},
      {t:"dip inicial de TFG ap√≥s in√≠cio de iSGLT2",c:"avaliar volemia e manter terap√™utica quando queda for esperada e sem sinais de gravidade",d:["suspender definitivamente na primeira eleva√ß√£o discreta de creatinina","associar AINE para estabilizar TFG","ignorar monitoriza√ß√£o laboratorial"],e:"Dip hemodin√¢mico inicial pode ocorrer; a conduta depende de contexto e monitoriza√ß√£o.",r:["dapa","empa"]},
      {t:"aumento >30% da creatinina em uso de iSGLT2 e m√∫ltiplos diur√©ticos",c:"rever status vol√™mico e ajuste de diur√©ticos antes de retirar definitivamente iSGLT2",d:["aumentar diur√©ticos imediatamente","ignorar mudan√ßa de creatinina","suspender todo bloqueio do SRAA de rotina"],e:"Hipovolemia iatrog√™nica deve ser pesquisada; frequentemente √© poss√≠vel reintrodu√ß√£o ap√≥s corre√ß√£o.",r:["kdigo_ckd"]},
      {t:"indica√ß√£o cl√°ssica de terapia renal substitutiva urgente na IRA",c:"edema agudo de pulm√£o refrat√°rio ao tratamento cl√≠nico",d:["creatinina 1,8 mg/dL isolada","ureia levemente elevada assintom√°tica","anemia normoc√≠tica"],e:"A decis√£o de TRS urgente √© cl√≠nico-laboratorial, n√£o baseada apenas em n√∫mero isolado.",r:["kdigo_aki"]},
      {t:"diagn√≥stico diferencial de hiponatremia",c:"avaliar osmolaridade plasm√°tica e estado vol√™mico para classificar mecanismo",d:["confirmar SIADH sem osmolaridade","corrigir rapidamente antes de investigar causa","usar s√≥ s√≥dio urin√°rio como crit√©rio √∫nico"],e:"A avalia√ß√£o estruturada evita pseudo-hiponatremia e erros terap√™uticos graves.",r:["hypona"]},
      {t:"risco neurol√≥gico na corre√ß√£o da hiponatremia cr√¥nica",c:"evitar sobrecorre√ß√£o para reduzir risco de s√≠ndrome de desmieliniza√ß√£o osm√≥tica",d:["corrigir o mais r√°pido poss√≠vel para normalizar em 6h","usar apenas solu√ß√£o hipot√¥nica","desconsiderar meta di√°ria"],e:"Velocidade de corre√ß√£o √© determinante de seguran√ßa neurol√≥gica.",r:["hypona"]},
      {t:"interpreta√ß√£o de FENa no diagn√≥stico de IRA",c:"contextualizar uso de diur√©tico e quadro cl√≠nico para evitar infer√™ncias indevidas",d:["considerar FENa isolada definitiva em qualquer cen√°rio","ignorar hemodin√¢mica","substituir sedimento urin√°rio por FENa"],e:"A utilidade da FENa depende do contexto e pode ser limitada por interven√ß√µes terap√™uticas.",r:["kdigo_aki"]},
      {t:"sedimento urin√°rio com cilindros hem√°ticos",c:"suspeitar processo glomerular ativo e acelerar investiga√ß√£o etiol√≥gica",d:["atribuir a contamina√ß√£o sem correla√ß√£o cl√≠nica","diagnosticar pielonefrite automaticamente","indicar antibi√≥tico emp√≠rico isolado"],e:"Cilindros hem√°ticos s√£o pista forte para origem glomerular do sangramento.",r:["kdigo_gn"]},
      {t:"manejo de GN rapidamente progressiva",c:"realizar investiga√ß√£o/tratamento precoce para reduzir perda funcional irrevers√≠vel",d:["observar por semanas sem interven√ß√£o","adiar imunossupress√£o at√© an√∫ria","basear decis√£o s√≥ em ureia"],e:"Tempo de interven√ß√£o impacta desfecho renal em doen√ßas glomerulares agressivas.",r:["kdigo_gn"]},
      {t:"doen√ßa anti-MBG com s√≠ndrome rapidamente progressiva",c:"considerar corticoterapia/imunossupress√£o e plasmaf√©rese conforme gravidade",d:["usar apenas diur√©tico","manter conduta expectante universal","iniciar AINE em alta dose"],e:"A estrat√©gia combinada pode limitar dano renal e pulmonar em cen√°rios selecionados.",r:["kdigo_gn"]},
      {t:"abordagem da s√≠ndrome nefr√≥tica com alto risco tromb√≥tico",c:"avaliar hipoalbuminemia e risco individual para decis√£o de tromboprofilaxia",d:["ignorar albumina s√©rica","usar anticoagula√ß√£o plena para todos","evitar qualquer monitoriza√ß√£o"],e:"A decis√£o antitromb√≥tica √© individualizada conforme etiologia, albumina e fatores de risco.",r:["kdigo_gn"]},
      {t:"meta de bicarbonato s√©rico em acidose metab√≥lica da DRC",c:"tender √† faixa normal-baixa com reposi√ß√£o individualizada",d:["aceitar bicarbonato persistentemente <18 mEq/L sem interven√ß√£o","corrigir para valores supranormais rotineiramente","usar s√≥ dieta sem reavaliar laborat√≥rio"],e:"Corre√ß√£o prudente da acidose pode melhorar desfechos cl√≠nicos/metab√≥licos.",r:["kdigo_ckd"]},
      {t:"estrat√©gia nutricional em DRC avan√ßada",c:"prescrever plano individualizado com controle de prote√≠na/s√≥dio/f√≥sforo conforme est√°gio",d:["adotar hiperproteica irrestrita","abolir acompanhamento nutricional","liberar s√≥dio sem limites"],e:"Nutri√ß√£o √© componente terap√™utico estruturante na DRC.",r:["kdoi"]},
      {t:"controle do metabolismo mineral √≥sseo na DRC",c:"monitorar tend√™ncia de c√°lcio, f√≥sforo e PTH para decis√µes sequenciais",d:["tratar f√≥sforo isoladamente sem tend√™ncia","desconsiderar PTH em est√°gios avan√ßados","interpretar exame √∫nico como definitivo"],e:"No CKD-MBD, tend√™ncia e contexto cl√≠nico importam mais que um ponto isolado.",r:["kdigo_mbd"]},
      {t:"manejo da hipercalemia recorrente em paciente com terapias nefroprotetoras",c:"buscar manter terapias de benef√≠cio com medidas diet√©ticas/farmacol√≥gicas e monitoriza√ß√£o",d:["suspender definitivamente SRAA em todos","ignorar medica√ß√µes contribuintes","evitar qualquer estrat√©gia de controle cr√¥nico de pot√°ssio"],e:"A meta atual √© preservar terapias de benef√≠cio sempre que poss√≠vel com manejo ativo de K.",r:["kdigo_ckd"]},
      {t:"interpreta√ß√£o da albumin√∫ria na pr√°tica",c:"confirmar persist√™ncia e excluir causas transit√≥rias como febre/exerc√≠cio",d:["diagnosticar DRC com √∫nica coleta sem contexto","ignorar variabilidade biol√≥gica","substituir ACR por fita isolada em seguimento"],e:"Persist√™ncia e reprodutibilidade s√£o essenciais para classifica√ß√£o de risco.",r:["kdigo_ckd"]},
      {t:"escolha de terapia dial√≠tica no preparo pr√©-TRS",c:"planejar de forma antecipada e compartilhada com paciente/fam√≠lia",d:["decidir somente em urg√™ncia dial√≠tica","adiar discuss√£o at√© eGFR <5 em todos","definir modalidade sem educa√ß√£o pr√©via"],e:"Planejamento precoce melhora acesso, ades√£o e qualidade de cuidado.",r:["kdigo_ckd"]},
      {t:"princ√≠pio-chave do cuidado peritoneal domiciliar",c:"treinamento rigoroso e preven√ß√£o de peritonite como pilares de sucesso",d:["dispensar t√©cnica ass√©ptica","substituir monitoriza√ß√£o por teleconsulta isolada","n√£o investigar dor abdominal no PD"],e:"Programa de DP robusto reduz infec√ß√£o e falha de t√©cnica.",r:["ispd"]},
      {t:"abordagem de bacteri√∫ria e ITU no transplante renal",c:"individualizar conforme tempo p√≥s-transplante, sintomas e risco",d:["tratar toda bacteri√∫ria assintom√°tica indefinidamente","ignorar sintomas urin√°rios em imunossuprimido","suspender imunossupressor sem avalia√ß√£o"],e:"A tomada de decis√£o no transplantado exige equil√≠brio entre infec√ß√£o e rejei√ß√£o.",r:["kdigo_tx"]},
      {t:"monitoriza√ß√£o de calcineur√≠nico no p√≥s-transplante",c:"ajustar dose por n√≠veis s√©ricos e contexto cl√≠nico do enxerto",d:["abolir dosagem de n√≠veis ap√≥s alta","usar AINE para proteger enxerto","manter dose fixa independente de fun√ß√£o renal"],e:"A janela terap√™utica estreita exige monitoriza√ß√£o cont√≠nua.",r:["kdigo_tx"]},
      {t:"queda aguda da fun√ß√£o do enxerto renal",c:"investigar sistematicamente causas pr√©-renais, obstrutivas, rejei√ß√£o e nefrotoxicidade",d:["presumir desidrata√ß√£o em todos","aumentar imunossupress√£o sem investiga√ß√£o","esperar resolu√ß√£o espont√¢nea por rotina"],e:"Perda de tempo diagn√≥stica pode custar fun√ß√£o do enxerto.",r:["kdigo_tx"]},
      {t:"estrat√©gia anti-hipertensiva na DRC com albumin√∫ria",c:"individualizar alvo e priorizar terapias com evid√™ncia de nefroprote√ß√£o",d:["tratar somente quando PA >180/110","desconsiderar albumin√∫ria para decis√£o","usar vasodilatador isolado sem bloqueio neuro-hormonal"],e:"Controle press√≥rico √© eixo central de redu√ß√£o de progress√£o renal e risco CV.",r:["kdigo_ckd"]},
      {t:"integra√ß√£o cardiorrenal na DRC",c:"abordar multifatorialmente PA, glicemia, albumin√∫ria, estilo de vida e risco CV",d:["focar em √∫nico marcador laboratorial","adiar interven√ß√µes at√© sintomas graves","tratar DRC e cora√ß√£o de forma dissociada"],e:"Abordagem integrada melhora desfechos renais e cardiovasculares.",r:["kdigo_ckd"]},
      {t:"indica√ß√£o de bi√≥psia renal na pr√°tica avan√ßada",c:"solicitar quando resultado tiver potencial real de mudar diagn√≥stico/conduta",d:["bi√≥psia em toda DRC est√°gio 3","contraindicar bi√≥psia em todos idosos","indicar apenas por creatinina discretamente elevada"],e:"Bi√≥psia deve ser orientada por utilidade cl√≠nica e risco-benef√≠cio.",r:["kdigo_gn"]},
      {t:"educa√ß√£o do paciente com DRC para prova de t√≠tulo",c:"entender como interven√ß√£o terap√™utica estruturada para ades√£o e reconhecimento de alarmes",d:["considerar irrelevante no progn√≥stico","limitar a orienta√ß√µes em crise","excluir familiar/cuidador do plano"],e:"Educa√ß√£o longitudinal impacta progress√£o, seguran√ßa e qualidade de vida.",r:["kdigo_ckd"]}
    ];
    const rarityPool=["common","common","common","rare","rare","epic","legendary"],rarityPower={common:1,rare:2,epic:3,legendary:4};
    const itemTable={weapon:[{n:"B√°culo de Creatinina",rar:"common",atk:2,def:0,kno:2,luck:0},{n:"L√¢mina da Al√ßa de Henle",rar:"rare",atk:5,def:1,kno:3,luck:1},{n:"Machado da Nefroprote√ß√£o",rar:"epic",atk:8,def:2,kno:4,luck:2},{n:"Lan√ßa do Glom√©rulo Ancestral",rar:"legendary",atk:12,def:4,kno:5,luck:3}],armor:[{n:"Jaleco de Plant√£o",rar:"common",atk:0,def:2,kno:1,luck:0},{n:"Manto Renocortical",rar:"rare",atk:1,def:5,kno:2,luck:0},{n:"Coura√ßa da Di√°lise",rar:"epic",atk:2,def:8,kno:3,luck:1},{n:"√âgide do N√©fron Primevo",rar:"legendary",atk:3,def:12,kno:4,luck:2}],relic:[{n:"Anel da Albumin√∫ria",rar:"common",atk:0,def:0,kno:2,luck:1},{n:"Sigilo de KDIGO",rar:"rare",atk:1,def:1,kno:4,luck:1},{n:"Orbe de Cistatina",rar:"epic",atk:2,def:2,kno:6,luck:2},{n:"Rel√≠quia dos T√≠tulos",rar:"legendary",atk:3,def:3,kno:9,luck:4}]};
    const milestones=[{level:3,msg:"üèÖ Guardi√£o do Ambulat√≥rio"},{level:5,msg:"üèÖ Sentinela da Albumin√∫ria"},{level:7,msg:"üèÖ Arcanista da Di√°lise"},{level:10,msg:"üèÖ Mestre das Glomerulopatias"},{level:13,msg:"üèÖ Lenda Cardiorrenal"},{level:16,msg:"üèÖ Arquimago do N√©fron"}];
    const weaponImg='assets/weapon-spear.svg',armorImg='assets/armor-aegis.svg',relicImg='assets/relic-orb.svg';

    function buildQuestionDeck(){const deck=[];for(let i=0;i<300;i++){const topic=topicBlueprints[i%topicBlueprints.length];const wrap=scenarioWrappers[Math.floor(i/topicBlueprints.length)%scenarioWrappers.length];const d=Math.min(12,4+Math.floor(i/25));const q=`${wrap} ${topic.t}?`;const opts=[topic.c,...topic.d];const rot=i%4;const o=opts.map((_,x)=>opts[(x+rot)%4]);deck.push({id:i+1,d,q,o,a:(4-rot)%4,e:topic.e,r:topic.r});}return deck;}
    const questions=buildQuestionDeck();
    const state={level:1,xp:0,xpToNext:120,score:0,lives:3,streak:0,gold:0,current:null,answered:false,used:new Set(),milestonesShown:new Set(),equipment:{weapon:{n:"Caneta do Interno",rar:"common",atk:0,def:0,kno:1,luck:0},armor:{n:"T√∫nica de Resid√™ncia",rar:"common",atk:0,def:1,kno:0,luck:0},relic:{n:"Ins√≠gnia do Plant√£o",rar:"common",atk:0,def:0,kno:1,luck:0}}};
    const $=id=>document.getElementById(id),ui={heroClass:$("heroClass"),heroFlavor:$("heroFlavor"),xpFill:$("xpFill"),xpLabel:$("xpLabel"),level:$("level"),score:$("score"),lives:$("lives"),record:$("record"),gold:$("gold"),streak:$("streak"),equipList:$("equipList"),journalLog:$("journalLog"),question:$("question"),options:$("options"),feedback:$("feedback"),refs:$("refs"),nextBtn:$("nextBtn"),newGameBtn:$("newGameBtn"),leaderboardBtn:$("leaderboardBtn"),leaderboardModal:$("leaderboardModal"),leaderboardBody:$("leaderboardBody"),closeLeaderboardBtn:$("closeLeaderboardBtn")};
    const getBoard=()=>JSON.parse(localStorage.getItem('nefroquest-leaderboard')||'[]'),saveBoard=l=>localStorage.setItem('nefroquest-leaderboard',JSON.stringify(l.slice(0,20)));
    function pushRecord(score,level){const l=getBoard();l.push({score,level,date:new Date().toLocaleString('pt-BR')});l.sort((a,b)=>b.score-a.score||b.level-a.level);saveBoard(l)}
    const best=()=>{const l=getBoard();return l.length?l[0].score:0};
    function stats(){return Object.values(state.equipment).reduce((a,i)=>(a.atk+=i.atk,a.def+=i.def,a.kno+=i.kno,a.luck+=i.luck,a),{atk:0,def:0,kno:0,luck:0})}
    function hero(level){if(level>=16)return["Arquimago do N√©fron",'"No escuro, voc√™ √© farol cl√≠nico."'];if(level>=13)return["Lenda Cardiorrenal",'"Integra√ß√£o √© sua magia mais poderosa."'];if(level>=10)return["Mestre das Glomerulopatias",'"Cada detalhe muda o desfecho."'];if(level>=7)return["Arcanista da Di√°lise",'"Precis√£o hemodin√¢mica em m√£os."'];if(level>=4)return["Guardi√£o da Nefroprote√ß√£o",'"Risco controlado, futuro preservado."'];return["Novi√ßo da Filtra√ß√£o",'"A noite √© longa, mas o n√©fron resiste."']}
    function log(m){const p=document.createElement('p');p.textContent=m;ui.journalLog.prepend(p);while(ui.journalLog.children.length>7)ui.journalLog.lastChild.remove()}
    function renderEquip(){const m={weapon:['‚öîÔ∏è Arma',weaponImg],armor:['üõ°Ô∏è Armadura',armorImg],relic:['üîÆ Rel√≠quia',relicImg]};ui.equipList.innerHTML=Object.entries(state.equipment).map(([k,v])=>`<div class='slot'><div class='slot-head'><img src='${m[k][1]}' alt='${k}'/><strong>${m[k][0]}:</strong> <span class='rar-${v.rar}'>${v.n}</span></div><small>ATK ${v.atk} ‚Ä¢ DEF ${v.def} ‚Ä¢ CONH ${v.kno} ‚Ä¢ SORTE ${v.luck}</small></div>`).join('')}
    function renderHUD(){const [c,f]=hero(state.level);ui.heroClass.textContent=c;ui.heroFlavor.textContent=f;ui.level.textContent=state.level;ui.score.textContent=state.score;ui.lives.textContent='‚ù§'.repeat(Math.max(0,state.lives))+'‚ô°'.repeat(3-Math.max(0,state.lives));ui.record.textContent=best();ui.gold.textContent=state.gold;ui.streak.textContent=state.streak;ui.xpFill.style.width=`${Math.min(100,state.xp/state.xpToNext*100)}%`;ui.xpLabel.textContent=`XP ${state.xp} / ${state.xpToNext} ‚Ä¢ Banco: ${questions.length} cartas`;renderEquip()}
    function chooseQuestion(){const cap=Math.min(12,Math.ceil(state.level/1.4)+3);let pool=questions.filter(q=>q.d<=cap&&!state.used.has(q.id));if(!pool.length){state.used.clear();pool=questions.filter(q=>q.d<=cap)}const q=pool[Math.floor(Math.random()*pool.length)];state.used.add(q.id);return q}
    function renderRefs(keys){const l=keys.map(k=>refsDB[k]).filter(Boolean);ui.refs.innerHTML=`<strong>Refer√™ncias:</strong><ul>${l.map(i=>`<li><a href='${i.url}' target='_blank' rel='noopener noreferrer'>${i.label}</a></li>`).join('')}</ul>`}
    function renderQuestion(){state.answered=false;state.current=chooseQuestion();ui.question.textContent=state.current.q;ui.options.innerHTML='';ui.feedback.className='feedback';ui.feedback.textContent='Escolha a melhor alternativa cl√≠nica.';renderRefs(state.current.r);ui.nextBtn.classList.add('hidden');state.current.o.forEach((opt,i)=>{const b=document.createElement('button');b.className='option';b.type='button';b.textContent=`${String.fromCharCode(65+i)}) ${opt}`;b.addEventListener('click',()=>answer(i,b));ui.options.appendChild(b)})}
    function rollItem(diff,luck){const slots=Object.keys(itemTable),slot=slots[Math.floor(Math.random()*slots.length)],bonus=Math.min(2,Math.floor((luck+diff)/8)),pool=[...rarityPool,...(bonus?["rare","epic"].slice(0,bonus):[])],rar=pool[Math.floor(Math.random()*pool.length)],c=itemTable[slot].filter(i=>i.rar===rar);return{slot,item:c[Math.floor(Math.random()*c.length)]}}
    function equipOrSell(slot,item){const old=state.equipment[slot],p1=old.atk+old.def+old.kno+old.luck+rarityPower[old.rar],p2=item.atk+item.def+item.kno+item.luck+rarityPower[item.rar];if(p2>p1){state.equipment[slot]=item;return`‚¨ÜÔ∏è Equipou ${item.n}.`}const s=15+p2*3;state.gold+=s;return`üí∞ ${item.n} virou ${s} ouro.`}
    function checkMilestones(){milestones.forEach(m=>{if(state.level>=m.level&&!state.milestonesShown.has(m.level)){state.milestonesShown.add(m.level);log(m.msg)}})}
    function gainXP(x){state.xp+=x;let up=0;while(state.xp>=state.xpToNext){state.xp-=state.xpToNext;state.level++;state.xpToNext=Math.floor(state.xpToNext*1.17);up++;if(state.level%6===0&&state.lives<3)state.lives++}return up}
    function answer(i,btn){if(state.answered)return;state.answered=true;const st=stats();const bs=[...document.querySelectorAll('.option')];bs.forEach(b=>b.disabled=true);const c=state.current.a;bs[c].classList.add('correct');if(i===c){state.streak++;const xp=28+state.current.d*10+state.streak*3+st.kno*2,g=10+state.current.d*4+Math.floor(st.luck/2);state.score+=95+state.current.d*20+state.streak*7+st.atk;state.gold+=g;const lv=gainXP(xp);if(Math.random()<Math.min(.88,.34+state.current.d*.03+st.luck*.01)){const drop=rollItem(state.current.d,st.luck);log(`üéÅ Drop [${drop.item.rar}] ${drop.item.n}. ${equipOrSell(drop.slot,drop.item)}`)}checkMilestones();ui.feedback.className='feedback good';ui.feedback.textContent=`‚úÖ Correto! ${state.current.e} +${xp} XP, +${g} ouro.${lv?` Level up x${lv}!`:''}`;}else{state.streak=0;btn.classList.add('wrong');const shield=Math.min(.35,st.def*.014),blocked=Math.random()<shield;if(!blocked)state.lives--;state.score=Math.max(0,state.score-(28-Math.min(20,st.def)));ui.feedback.className='feedback bad';ui.feedback.textContent=blocked?`üõ°Ô∏è Errou, mas sua defesa absorveu o dano. Dificuldade da carta errada: ${state.current.d}. ${state.current.e}`:`‚ùå Resposta incorreta. Dificuldade da carta errada: ${state.current.d}. ${state.current.e}`;log(`‚ö†Ô∏è Carta falhada (dificuldade ${state.current.d}).`)}renderHUD();state.lives<=0?finishGame():ui.nextBtn.classList.remove('hidden')}
    function finishGame(){pushRecord(state.score,state.level);ui.question.textContent=`Fim da jornada! Pontos: ${state.score} ‚Ä¢ N√≠vel: ${state.level}.`;ui.options.innerHTML='';ui.feedback.className='feedback';ui.feedback.textContent='As 3 vidas acabaram. Clique em Novo jogo para recome√ßar.';renderRefs(["kdigo_ckd","kdigo_aki","kdigo_gn","kdigo_tx","dapa","empa"]);renderHUD();renderLeaderboard()}
    function resetGame(){Object.assign(state,{level:1,xp:0,xpToNext:120,score:0,lives:3,streak:0,gold:0,current:null,answered:false});state.used.clear();state.milestonesShown.clear();state.equipment={weapon:{n:"Caneta do Interno",rar:"common",atk:0,def:0,kno:1,luck:0},armor:{n:"T√∫nica de Resid√™ncia",rar:"common",atk:0,def:1,kno:0,luck:0},relic:{n:"Ins√≠gnia do Plant√£o",rar:"common",atk:0,def:0,kno:1,luck:0}};ui.journalLog.innerHTML='';log('üìñ Nova jornada iniciada no Reino Sombrio do N√©fron.');renderHUD();renderQuestion()}
    function renderLeaderboard(){const b=getBoard().slice(0,10);ui.leaderboardBody.innerHTML=b.length?b.map((r,i)=>`<tr><td>${i+1}</td><td>${r.score}</td><td>${r.level}</td><td>${r.date}</td></tr>`).join(''):'<tr><td colspan="4">Sem registros ainda.</td></tr>'}
    ui.nextBtn.addEventListener('click',renderQuestion);ui.newGameBtn.addEventListener('click',resetGame);ui.leaderboardBtn.addEventListener('click',()=>{renderLeaderboard();ui.leaderboardModal.classList.remove('hidden')});ui.closeLeaderboardBtn.addEventListener('click',()=>ui.leaderboardModal.classList.add('hidden'));
    resetGame();
  </script>
</body>
</html>
